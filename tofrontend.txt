# üìã ESPECIFICACIONES PARA FRONTEND - M√≥dulos Banks, Apps, BankPayments y AppPayments

## üéØ CONTEXTO DE IMPLEMENTACI√ìN

### Vista de Detalle de Sucursal
- La gesti√≥n completa de **Banks** y **Apps** se realizar√° desde la vista de detalle de sucursal
- Los **AppPayments** solo se pueden crear/modificar desde la toma de pedidos y/o detalle de pedido
- Los **BankPayments** se crean autom√°ticamente cuando se liquidan AppPayments y tambien se  crear/modificar desde la toma de pedidos y/o detalle de pedido

### Funcionalidades de AppPayments
- ‚úÖ **Crear/Actualizar**: Solo desde toma de pedidos o modificaci√≥n de pedidos
- ‚úÖ **Ver**: Listado con filtros avanzados
- ‚úÖ **Filtrar**: Por app, banco, sucursal, estado, fechas
- ‚úÖ **Setear (Liquidar)**: Individual o m√∫ltiple (din√°mico seg√∫n cantidad)
- ‚úÖ **Confirmar transferencias**: Verificar BankPayments

---

## üè¶ BANKS - Gesti√≥n de Bancos

### üìç Base URL: `/api/banks`

### 1. **GET** `/api/banks` - Lista paginada de bancos
**Descripci√≥n**: Obtiene una lista paginada de bancos con filtros
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Query):
```
branchId?: number          // Solo superadmin puede especificar
name?: string              // Filtro por nombre
active?: boolean           // Filtro por estado activo
page: number = 1           // P√°gina actual
pageSize: number = 10      // Elementos por p√°gina
sortBy: string = "name"    // Campo de ordenamiento
sortOrder: string = "asc"  // Orden (asc/desc)
```

**Respuesta exitosa** (200):
```json
{
  "items": [
    {
      "id": 1,
      "branchId": 1,
      "branchName": "Sucursal Centro",
      "name": "Bancolombia",
      "imageUrl": "https://example.com/logo.png",
      "active": true,
      "createdAt": "2024-01-01T10:00:00Z",
      "updatedAt": "2024-01-01T10:00:00Z",
      "totalApps": 5,
      "activeApps": 4,
      "currentBalance": 1500000.00
    }
  ],
  "totalCount": 10,
  "page": 1,
  "pageSize": 10,
  "totalPages": 1
}
```

### 2. **GET** `/api/banks/{id}` - Obtener banco por ID
**Descripci√≥n**: Obtiene un banco espec√≠fico con estad√≠sticas b√°sicas
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
id: number                 // ID del banco
```

**Respuesta exitosa** (200):
```json
{
  "id": 1,
  "branchId": 1,
  "branchName": "Sucursal Centro",
  "name": "Bancolombia",
  "imageUrl": "https://example.com/logo.png",
  "active": true,
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "totalApps": 5,
  "activeApps": 4,
  "currentBalance": 1500000.00
}
```

### 3. **GET** `/api/banks/{id}/detail` - Vista detallada del banco
**Descripci√≥n**: Obtiene informaci√≥n detallada del banco con estad√≠sticas completas
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
id: number                 // ID del banco
```

**Respuesta exitosa** (200):
```json
{
  "id": 1,
  "branchId": 1,
  "branchName": "Sucursal Centro",
  "name": "Bancolombia",
  "imageUrl": "https://example.com/logo.png",
  "active": true,
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "totalApps": 5,
  "activeApps": 4,
  "totalBankPayments": 2500000.00,
  "totalExpenseBankPayments": 500000.00,
  "currentBalance": 1500000.00
}
```

### 4. **POST** `/api/banks` - Crear nuevo banco
**Descripci√≥n**: Crea un nuevo banco
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Body):
```json
{
  "branchId": 1,                    // Solo superadmin especifica
  "name": "Bancolombia",            // Requerido, m√°ximo 150 caracteres
  "imageUrl": "https://example.com/logo.png", // Opcional, m√°ximo 200 caracteres
  "active": true                    // Default: true
}
```

**Respuesta exitosa** (201):
```json
{
  "id": 1,
  "branchId": 1,
  "branchName": "Sucursal Centro",
  "name": "Bancolombia",
  "imageUrl": "https://example.com/logo.png",
  "active": true,
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "totalApps": 0,
  "activeApps": 0,
  "currentBalance": 0.00
}
```

### 5. **PUT** `/api/banks/{id}` - Actualizar banco
**Descripci√≥n**: Actualiza un banco existente
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route + Body):
```
id: number                 // ID del banco
```
```json
{
  "name": "Bancolombia Actualizado",
  "imageUrl": "https://example.com/new-logo.png",
  "active": true
}
```

**Respuesta exitosa** (200): Mismo formato que GET por ID

### 6. **DELETE** `/api/banks/{id}` - Eliminar banco
**Descripci√≥n**: Elimina un banco (soft delete)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del banco
```

**Respuesta exitosa** (204): Sin contenido

---

## üì± APPS - Gesti√≥n de Aplicaciones

### üìç Base URL: `/api/apps`

### 1. **GET** `/api/apps` - Lista paginada de apps
**Descripci√≥n**: Obtiene una lista paginada de apps con filtros
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Query):
```
bankId?: number            // Filtro por banco
name?: string              // Filtro por nombre
branchId?: number          // Solo superadmin puede especificar
active?: boolean           // Filtro por estado activo
page: number = 1           // P√°gina actual
pageSize: number = 10      // Elementos por p√°gina
sortBy: string = "name"    // Campo de ordenamiento
sortOrder: string = "asc"  // Orden (asc/desc)
```

**Respuesta exitosa** (200):
```json
{
  "items": [
    {
      "id": 1,
      "bankId": 1,
      "bankName": "Bancolombia",
      "branchId": 1,
      "branchName": "Sucursal Centro",
      "name": "Nequi",
      "imageUrl": "https://example.com/nequi-logo.png",
      "active": true,
      "createdAt": "2024-01-01T10:00:00Z",
      "updatedAt": "2024-01-01T10:00:00Z",
      "totalPayments": 500000.00,
      "unsettledPayments": 100000.00,
      "totalPaymentsCount": 25,
      "unsettledPaymentsCount": 5
    }
  ],
  "totalCount": 10,
  "page": 1,
  "pageSize": 10,
  "totalPages": 1
}
```

### 2. **GET** `/api/apps/{id}` - Obtener app por ID
**Descripci√≥n**: Obtiene una app espec√≠fica con estad√≠sticas
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
id: number                 // ID de la app
```

**Respuesta exitosa** (200): Mismo formato que item del listado

### 3. **GET** `/api/apps/by-bank/{bankId}` - Apps por banco
**Descripci√≥n**: Obtiene todas las apps de un banco espec√≠fico
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
bankId: number             // ID del banco
```

**Respuesta exitosa** (200):
```json
[
  {
    "id": 1,
    "bankId": 1,
    "bankName": "Bancolombia",
    "branchId": 1,
    "branchName": "Sucursal Centro",
    "name": "Nequi",
    "imageUrl": "https://example.com/nequi-logo.png",
    "active": true,
    "createdAt": "2024-01-01T10:00:00Z",
    "updatedAt": "2024-01-01T10:00:00Z",
    "totalPayments": 500000.00,
    "unsettledPayments": 100000.00,
    "totalPaymentsCount": 25,
    "unsettledPaymentsCount": 5
  }
]
```

### 4. **POST** `/api/apps` - Crear nueva app
**Descripci√≥n**: Crea una nueva app
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Body):
```json
{
  "bankId": 1,                        // Requerido
  "name": "Nequi",                    // Requerido, m√°ximo 150 caracteres
  "imageUrl": "https://example.com/nequi-logo.png", // Opcional, m√°ximo 200 caracteres
  "active": true                      // Default: true
}
```

**Respuesta exitosa** (201): Mismo formato que GET por ID

### 5. **PUT** `/api/apps/{id}` - Actualizar app
**Descripci√≥n**: Actualiza una app existente
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route + Body):
```
id: number                 // ID de la app
```
```json
{
  "bankId": 1,
  "name": "Nequi Actualizado",
  "imageUrl": "https://example.com/new-nequi-logo.png",
  "active": true
}
```

**Respuesta exitosa** (200): Mismo formato que GET por ID

### 6. **DELETE** `/api/apps/{id}` - Eliminar app
**Descripci√≥n**: Elimina una app (soft delete)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID de la app
```

**Respuesta exitosa** (204): Sin contenido

---

## üí∞ BANK PAYMENTS - Gesti√≥n de Pagos Bancarios

### üìç Base URL: `/api/bankpayments`

### 1. **GET** `/api/bankpayments` - Lista paginada de pagos bancarios
**Descripci√≥n**: Obtiene una lista paginada de pagos bancarios con filtros
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Query):
```
orderId?: number           // Filtro por orden
bankId?: number            // Filtro por banco
branchId?: number          // Solo superadmin puede especificar
verified?: boolean         // Filtro por estado de verificaci√≥n
fromDate?: string          // Filtro desde fecha (ISO 8601)
toDate?: string            // Filtro hasta fecha (ISO 8601)
page: number = 1           // P√°gina actual
pageSize: number = 10      // Elementos por p√°gina
sortBy: string = "createdAt" // Campo de ordenamiento
sortOrder: string = "desc"   // Orden (asc/desc)
```

**Respuesta exitosa** (200):
```json
{
  "items": [
    {
      "id": 1,
      "orderId": 123,
      "bankId": 1,
      "bankName": "Bancolombia",
      "branchId": 1,
      "branchName": "Sucursal Centro",
      "amount": 50000.00,
      "verifiedAt": "2024-01-01T15:30:00Z",
      "isVerified": true,
      "createdAt": "2024-01-01T10:00:00Z",
      "updatedAt": "2024-01-01T15:30:00Z"
    }
  ],
  "totalCount": 10,
  "page": 1,
  "pageSize": 10,
  "totalPages": 1
}
```

### 2. **GET** `/api/bankpayments/{id}` - Obtener pago bancario por ID
**Descripci√≥n**: Obtiene un pago bancario espec√≠fico
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago bancario
```

**Respuesta exitosa** (200): Mismo formato que item del listado

### 3. **GET** `/api/bankpayments/unverified` - Pagos no verificados
**Descripci√≥n**: Obtiene todos los pagos bancarios no verificados
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada**: Ninguno

**Respuesta exitosa** (200): Array de pagos bancarios (mismo formato que items del listado)

### 4. **POST** `/api/bankpayments` - Crear pago bancario
**Descripci√≥n**: Crea un nuevo pago bancario (generalmente autom√°tico)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Body):
```json
{
  "orderId": 123,                    // Requerido
  "bankId": 1,                       // Requerido
  "amount": 50000.00                 // Requerido, mayor a 0
}
```

**Respuesta exitosa** (201): Mismo formato que GET por ID

### 5. **POST** `/api/bankpayments/{id}/verify` - Verificar pago bancario
**Descripci√≥n**: Marca un pago bancario como verificado
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route + Body):
```
id: number                 // ID del pago bancario
```
```json
{
  "verifiedAt": "2024-01-01T15:30:00Z" // Opcional, default: fecha actual
}
```

**Respuesta exitosa** (200):
```json
{
  "message": "Pago bancario verificado exitosamente"
}
```

### 6. **POST** `/api/bankpayments/{id}/unverify` - Desverificar pago bancario
**Descripci√≥n**: Marca un pago bancario como no verificado
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago bancario
```

**Respuesta exitosa** (200):
```json
{
  "message": "Pago bancario desverificado exitosamente"
}
```

### 7. **DELETE** `/api/bankpayments/{id}` - Eliminar pago bancario
**Descripci√≥n**: Elimina un pago bancario
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago bancario
```

**Respuesta exitosa** (204): Sin contenido

---

## üí≥ APP PAYMENTS - Gesti√≥n de Pagos de Apps

### üìç Base URL: `/api/apppayments`

### ‚ö†Ô∏è IMPORTANTE: CREACI√ìN Y MODIFICACI√ìN
- **Crear/Actualizar**: Solo desde toma de pedidos o modificaci√≥n de pedidos
- **Ver/Filtrar/Setear**: Disponible desde vista de gesti√≥n

### 1. **GET** `/api/apppayments` - Lista paginada de pagos de apps
**Descripci√≥n**: Obtiene una lista paginada de pagos de apps con filtros
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Query):
```
orderId?: number           // Filtro por orden
appId?: number             // Filtro por app
bankId?: number            // Filtro por banco
branchId?: number          // Solo superadmin puede especificar
settled?: boolean          // Filtro por estado de liquidaci√≥n
fromDate?: string          // Filtro desde fecha (ISO 8601)
toDate?: string            // Filtro hasta fecha (ISO 8601)
page: number = 1           // P√°gina actual
pageSize: number = 10      // Elementos por p√°gina
sortBy: string = "createdAt" // Campo de ordenamiento
sortOrder: string = "desc"   // Orden (asc/desc)
```

**Respuesta exitosa** (200):
```json
{
  "items": [
    {
      "id": 1,
      "orderId": 123,
      "appId": 1,
      "appName": "Nequi",
      "bankId": 1,
      "bankName": "Bancolombia",
      "branchId": 1,
      "branchName": "Sucursal Centro",
      "amount": 50000.00,
      "isSetted": false,
      "createdAt": "2024-01-01T10:00:00Z",
      "updatedAt": "2024-01-01T10:00:00Z"
    }
  ],
  "totalCount": 10,
  "page": 1,
  "pageSize": 10,
  "totalPages": 1
}
```

### 2. **GET** `/api/apppayments/{id}` - Obtener pago de app por ID
**Descripci√≥n**: Obtiene un pago de app espec√≠fico
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago de app
```

**Respuesta exitosa** (200): Mismo formato que item del listado

### 3. **GET** `/api/apppayments/unsettled` - Pagos no liquidados
**Descripci√≥n**: Obtiene todos los pagos de apps no liquidados
**Autorizaci√≥n**: Todos los usuarios autenticados
**Par√°metros de entrada** (Query):
```
appId?: number             // Filtro por app
fromDate?: string          // Filtro desde fecha (ISO 8601)
toDate?: string            // Filtro hasta fecha (ISO 8601)
page: number = 1           // P√°gina actual
pageSize: number = 10      // Elementos por p√°gina
```

**Respuesta exitosa** (200): Array de pagos de apps (mismo formato que items del listado)

### 4. **POST** `/api/apppayments` - Crear pago de app
**Descripci√≥n**: Crea un nuevo pago de app (SOLO desde toma de pedidos)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Body):
```json
{
  "orderId": 123,                    // Requerido
  "appId": 1,                        // Requerido
  "amount": 50000.00                 // Requerido, mayor a 0
}
```

**Respuesta exitosa** (201): Mismo formato que GET por ID

### 5. **POST** `/api/apppayments/{id}/settle` - Liquidar pago individual
**Descripci√≥n**: Liquida un pago de app individual (marca como settled y crea bank payment)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago de app
```

**Respuesta exitosa** (200):
```json
{
  "message": "Pago de app liquidado exitosamente. Se cre√≥ el bank payment correspondiente."
}
```

### 6. **POST** `/api/apppayments/settle-multiple` - Liquidar m√∫ltiples pagos
**Descripci√≥n**: Liquida m√∫ltiples pagos de apps (marca como settled y crea UN SOLO bank payment)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Body):
```json
{
  "paymentIds": [1, 2, 3, 4, 5]     // Array de IDs de pagos a liquidar
}
```

**Respuesta exitosa** (200):
```json
{
  "message": "Pagos de apps liquidados exitosamente. Se cre√≥ un bank payment con el total."
}
```

### 7. **POST** `/api/apppayments/{id}/unsettle` - Desliquidar pago
**Descripci√≥n**: Desliquida un pago de app (marca como unsettled y elimina bank payment)
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago de app
```

**Respuesta exitosa** (200):
```json
{
  "message": "Pago de app desliquidado exitosamente. Se elimin√≥ el bank payment correspondiente."
}
```

### 8. **DELETE** `/api/apppayments/{id}` - Eliminar pago de app
**Descripci√≥n**: Elimina un pago de app
**Autorizaci√≥n**: admin, superadmin
**Par√°metros de entrada** (Route):
```
id: number                 // ID del pago de app
```

**Respuesta exitosa** (204): Sin contenido

---

## üéØ ESPECIFICACIONES DE IMPLEMENTACI√ìN FRONTEND

### üìç Vista de Detalle de Sucursal
La gesti√≥n completa de **Banks** y **Apps** se debe integrar en la vista de detalle de sucursal:

#### Secci√≥n de Bancos:
- Lista de bancos de la sucursal
- Botones: Crear, Editar, Eliminar, Ver Detalle
- Filtros: Nombre, Estado activo
- Estad√≠sticas: Total apps, apps activas, balance actual

#### Secci√≥n de Apps:
- Lista de apps por banco
- Botones: Crear, Editar, Eliminar
- Filtros: Banco, Nombre, Estado activo
- Estad√≠sticas: Total pagos, pagos no liquidados

### üìç Gesti√≥n de AppPayments

#### Restricciones de Creaci√≥n/Modificaci√≥n:
- **NO** incluir botones de "Crear" o "Editar" en la interfaz de gesti√≥n
- **S√ç** incluir vista de solo lectura con filtros avanzados
- **S√ç** incluir funcionalidad de liquidaci√≥n (setear)

#### Funcionalidad de Liquidaci√≥n Din√°mica:
```javascript
// L√≥gica para determinar endpoint seg√∫n cantidad de registros seleccionados
const selectedPayments = getSelectedAppPayments(); // Array de IDs

if (selectedPayments.length === 1) {
    // Usar endpoint individual
    await fetch(`/api/apppayments/${selectedPayments[0]}/settle`, {
        method: 'POST'
    });
} else if (selectedPayments.length > 1) {
    // Usar endpoint m√∫ltiple
    await fetch('/api/apppayments/settle-multiple', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentIds: selectedPayments })
    });
}
```

#### Interfaz de Liquidaci√≥n:
- Checkbox para selecci√≥n m√∫ltiple
- Bot√≥n "Liquidar Seleccionados" (din√°mico seg√∫n cantidad)
- Bot√≥n "Desliquidar" para pagos ya liquidados
- Confirmaci√≥n antes de liquidar con resumen de montos

### üìç Gesti√≥n de BankPayments

#### Funcionalidad de Verificaci√≥n:
- Lista de pagos bancarios con estado de verificaci√≥n
- Botones "Verificar" y "Desverificar"
- Filtro especial para "Pagos No Verificados"
- Indicador visual del estado de verificaci√≥n

#### Flujo de Trabajo:
1. AppPayment se liquida ‚Üí BankPayment se crea autom√°ticamente
2. BankPayment aparece en lista de "No Verificados"
3. Usuario verifica el BankPayment
4. Se actualiza el estado y timestamp de verificaci√≥n

---

## üîê AUTORIZACI√ìN Y PERMISOS

### Roles y Acceso:
- **superadmin**: Acceso completo a todas las sucursales
- **admin**: Solo acceso a su sucursal
- **cashier**: Solo lectura de datos de su sucursal
- **kitchen**: Sin acceso a estos m√≥dulos
- **deliveryman**: Sin acceso a estos m√≥dulos

### Endpoints por Rol:
- **Crear/Editar/Eliminar**: admin, superadmin
- **Ver/Listar/Filtrar**: Todos los usuarios autenticados
- **Liquidar/Verificar**: admin, superadmin

---

## üìä C√ìDIGOS DE RESPUESTA HTTP

### √âxito:
- **200**: OK - Operaci√≥n exitosa
- **201**: Created - Recurso creado exitosamente
- **204**: No Content - Eliminaci√≥n exitosa

### Error:
- **400**: Bad Request - Datos inv√°lidos
- **401**: Unauthorized - No autenticado
- **403**: Forbidden - Sin permisos
- **404**: Not Found - Recurso no encontrado
- **500**: Internal Server Error - Error del servidor

---

## üîÑ FLUJO DE LIQUIDACI√ìN COMPLETO

### 1. Liquidaci√≥n Individual:
```
AppPayment (isSetted: false) 
    ‚Üì POST /api/apppayments/{id}/settle
AppPayment (isSetted: true) + BankPayment (creado autom√°ticamente)
```

### 2. Liquidaci√≥n M√∫ltiple:
```
AppPayment1 (isSetted: false) 
AppPayment2 (isSetted: false) 
AppPayment3 (isSetted: false)
    ‚Üì POST /api/apppayments/settle-multiple
AppPayment1 (isSetted: true)
AppPayment2 (isSetted: true) 
AppPayment3 (isSetted: true)
+ BankPayment (con suma total)
```

### 3. Verificaci√≥n:
```
BankPayment (verifiedAt: null)
    ‚Üì POST /api/bankpayments/{id}/verify
BankPayment (verifiedAt: timestamp)
```

### 4. Reversi√≥n:
```
AppPayment (isSetted: true) + BankPayment
    ‚Üì POST /api/apppayments/{id}/unsettle
AppPayment (isSetted: false) + BankPayment (eliminado)
```

---

## üìù NOTAS IMPORTANTES

1. **Consistencia de Tipos**: Todos los montos son `decimal` para precisi√≥n
2. **Soft Delete**: Las eliminaciones son l√≥gicas, no f√≠sicas
3. **Auditor√≠a**: Todos los cambios quedan registrados con timestamps
4. **Integridad**: No se pueden eliminar entidades con relaciones activas
5. **Filtrado Autom√°tico**: Los usuarios solo ven datos de su sucursal (excepto superadmin)
6. **Estad√≠sticas en Tiempo Real**: Se calculan din√°micamente en cada consulta

Este archivo proporciona toda la informaci√≥n necesaria para implementar la interfaz frontend completa de los m√≥dulos de gesti√≥n financiera del sistema.
